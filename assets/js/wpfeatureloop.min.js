(function(){"use strict";class p{constructor(t,e){this.config=e,this.projectId=e.project_id||"",this.container=t,this.features=[],this.currentCommentFeatureId=null,this.currentComments=[],this.t=e.i18n||{},this.templates={},this.featureModal=null,this.commentModal=null,this.toast=null,this.apiBase=e.rest_url||"/wp-json/wpfeatureloop/v1"}q(t){return this.container.querySelector(t)}getTemplate(t){const e=`wfl-template-${t}`;if(!this.templates[e]){const o=this.q(`#${e}`);if(!o)return console.error(`WPFeatureLoop: Template not found: ${e}`),null;this.templates[e]=o}return this.templates[e]}cloneTemplate(t){const e=this.getTemplate(t);return e?e.content.cloneNode(!0).firstElementChild:null}init(){this.cacheElements(),this.loadFeatures()}cacheElements(){["card","status","empty","error","comment","no-comments","header","skeleton"].forEach(e=>this.getTemplate(e)),this.featureModal=this.q("#wfl-modal"),this.commentModal=this.q("#wfl-comment-modal"),this.toast=this.q("#wfl-toast"),this.featureModal&&this.featureModal.remove(),this.commentModal&&this.commentModal.remove(),this.toast&&this.toast.remove(),this.attachModalListeners()}async loadFeatures(){try{const t=await this.api("GET","/features");t.features?(this.features=t.features,this.render()):Array.isArray(t)?(this.features=t,this.render()):this.renderError()}catch(t){console.error("WPFeatureLoop: Failed to load features",t),this.renderError()}}async api(t,e,o=null){const s=e.includes("?")?"&":"?",n=this.apiBase+e+s+"project_id="+encodeURIComponent(this.projectId),a={method:t,headers:{"Content-Type":"application/json","X-WP-Nonce":this.config.nonce},credentials:"same-origin"};o&&(t==="POST"||t==="PUT"||t==="PATCH")&&(a.body=JSON.stringify(o));const i=await fetch(n,a),r=await i.json();if(!i.ok)throw new Error(r.error||"Request failed");return r}render(){const e=this.getTemplate("header").content.cloneNode(!0),o=e.querySelector(".wfl-add-feature-btn");o&&this.config.can_interact&&(o.style.display="",o.removeAttribute("disabled"));const s=document.createElement("div");if(s.className="wfl-list",this.features.length>0)this.features.forEach(n=>{const a=this.createCard(n);a&&s.appendChild(a)});else{const n=this.cloneTemplate("empty");n&&s.appendChild(n)}this.container.innerHTML="",this.container.appendChild(e),this.container.appendChild(s),this.featureModal&&this.container.appendChild(this.featureModal),this.commentModal&&this.container.appendChild(this.commentModal),this.toast&&this.container.appendChild(this.toast),this.container.removeAttribute("data-loading"),this.attachEventListeners()}createCard(t){const e=this.cloneTemplate("card");if(!e)return null;const o=t.votes>0?"wfl-vote-positive":t.votes<0?"wfl-vote-negative":"",s=t.userVote==="up",n=t.userVote==="down",a=t.commentsCount===1?this.t.comment||"comment":this.t.comments||"comments";e.dataset.id=t.id;const i=e.querySelector(".wfl-vote-up");i.dataset.id=t.id,i.dataset.tooltip=this.t.upvote||"Upvote",s&&i.classList.add("wfl-voted");const r=e.querySelector(".wfl-vote-count");r.dataset.id=t.id,r.textContent=t.votes,o&&r.classList.add(o);const c=e.querySelector(".wfl-vote-down");c.dataset.id=t.id,c.dataset.tooltip=this.t.downvote||"Downvote",n&&c.classList.add("wfl-voted");const u=e.querySelector(".wfl-feature-title");u.dataset.id=t.id,u.textContent=t.title;const l=e.querySelector(".wfl-status"),m=l.querySelector(".wfl-status-label");l.className=`wfl-status wfl-status-${t.status||"open"}`,m.textContent=this.getStatusLabel(t.status||"open");const d=e.querySelector(".wfl-description");d.textContent=t.description||"";const f=e.querySelector(".wfl-comment-trigger");f.dataset.id=t.id;const w=e.querySelector(".wfl-comment-count");return w.textContent=`${t.commentsCount} ${a}`,e}getStatusLabel(t){return{open:this.t.statusOpen||"Open",planned:this.t.statusPlanned||"Planned","in-progress":this.t.statusProgress||"In Progress",progress:this.t.statusProgress||"In Progress",completed:this.t.statusCompleted||"Completed",inbox:this.t.statusInbox||"Inbox"}[t]||t}renderError(){const e=this.getTemplate("header").content.cloneNode(!0),o=this.cloneTemplate("error");if(this.container.innerHTML="",this.container.appendChild(e),o){this.container.appendChild(o);const s=this.container.querySelector(".wfl-retry-btn");s&&s.addEventListener("click",()=>this.loadFeatures())}this.featureModal&&this.container.appendChild(this.featureModal),this.commentModal&&this.container.appendChild(this.commentModal),this.toast&&this.container.appendChild(this.toast),this.container.removeAttribute("data-loading")}createComment(t){const e=this.cloneTemplate("comment");if(!e)return null;t.isTeamReply&&e.classList.add("wfl-comment-team");const o=e.querySelector(".wfl-comment-avatar");o.textContent=t.initials||"?",t.isTeamReply&&o.classList.add("wfl-comment-avatar-team");const s=e.querySelector(".wfl-comment-content");t.isTeamReply&&s.classList.add("wfl-comment-content-team");const n=e.querySelector(".wfl-comment-author");n.textContent=t.author||"Anonymous";const a=e.querySelector(".wfl-comment-team-badge");t.isTeamReply&&a&&(a.style.display="");const i=e.querySelector(".wfl-comment-time");i.textContent=t.time||"";const r=e.querySelector(".wfl-comment-text");return r.textContent=t.text||"",e}renderCommentsList(t,e){if(e.innerHTML="",t.length===0){const o=this.cloneTemplate("no-comments");o&&e.appendChild(o);return}t.forEach(o=>{const s=this.createComment(o);s&&e.appendChild(s)})}attachModalListeners(){if(this.featureModal){const t=this.featureModal.querySelector("#wfl-modal-close"),e=this.featureModal.querySelector("#wfl-modal-cancel"),o=this.featureModal.querySelector("#wfl-modal-submit");t?.addEventListener("click",()=>this.closeModal()),e?.addEventListener("click",()=>this.closeModal()),this.featureModal.addEventListener("click",s=>{s.target===this.featureModal&&this.closeModal()}),o?.addEventListener("click",()=>this.handleSubmitFeature())}this.commentModal&&(this.commentModal.querySelector("#wfl-comment-modal-close")?.addEventListener("click",()=>this.closeCommentModal()),this.commentModal.addEventListener("click",e=>{e.target===this.commentModal&&this.closeCommentModal()}))}attachEventListeners(){const t=this.container.querySelector(".wfl-add-feature-btn");t&&t.addEventListener("click",()=>this.openModal()),this.features.forEach(e=>this.attachCardListeners(e.id))}attachCardListeners(t){const e=this.container.querySelector(`.wfl-card[data-id="${t}"]`);if(!e)return;e.querySelectorAll(".wfl-vote-btn").forEach(s=>{s.addEventListener("click",n=>{n.stopPropagation(),this.handleVote(s)})});const o=e.querySelector(".wfl-comment-trigger");o&&o.addEventListener("click",()=>{this.openCommentModal(t)})}openModal(){this.featureModal&&this.featureModal.classList.add("wfl-active")}closeModal(){if(this.featureModal){this.featureModal.classList.remove("wfl-active");const t=this.featureModal.querySelector("#wfl-feature-title"),e=this.featureModal.querySelector("#wfl-feature-desc");t&&(t.value=""),e&&(e.value="")}}async handleSubmitFeature(){const t=this.featureModal?.querySelector("#wfl-feature-title"),e=this.featureModal?.querySelector("#wfl-feature-desc"),o=t?.value.trim()||"",s=e?.value.trim()||"";if(!o||!s){this.showToast(this.t.fillAllFields||"Please fill in all fields","error");return}const n=this.featureModal?.querySelector("#wfl-modal-submit");n&&(n.disabled=!0);try{const a=await this.api("POST","/features",{title:o,description:s});if(this.closeModal(),a.isPending)this.showToast(a.message||this.t.featurePending||"Your suggestion has been submitted and will be reviewed.","success");else{this.features.unshift(a);const i=this.container.querySelector(".wfl-list"),r=i?.querySelector(".wfl-empty");r&&r.remove();const c=this.createCard(a);c&&i&&(i.insertBefore(c,i.firstChild),this.attachCardListeners(a.id)),this.showToast(this.t.featureSubmitted||"Feature submitted successfully!","success")}}catch(a){console.error("WPFeatureLoop: Failed to create feature",a),this.showToast(a.message||this.t.errorText||"Please try again later.","error")}finally{n&&(n.disabled=!1)}}async openCommentModal(t){const e=this.features.find(i=>i.id===t);if(!e)return;this.currentCommentFeatureId=t;const o=this.commentModal,s=this.commentModal?.querySelector("#wfl-comments-list"),n=this.commentModal?.querySelector("#wfl-comment-title"),a=this.commentModal?.querySelector("#wfl-comment-input");if(a&&(a.value=""),n&&(n.textContent=e.title),s){const i=this.cloneTemplate("skeleton");s.innerHTML="",i&&s.appendChild(i)}o&&o.classList.add("wfl-active");try{const i=await this.api("GET",`/features/${t}/comments`);this.currentComments=i.comments||[],s&&this.renderCommentsList(this.currentComments,s),this.attachCommentListeners(t,e)}catch(i){console.error("WPFeatureLoop: Failed to load comments",i),s&&(s.innerHTML=`<p style="text-align: center; color: var(--wfl-danger);">${this.t.errorText||"Please try again later."}</p>`)}}attachCommentListeners(t,e){const o=this,s=this.commentModal?.querySelector("#wfl-comments-list"),n=async()=>{const r=o.commentModal?.querySelector("#wfl-comment-input"),c=o.commentModal?.querySelector("#wfl-comment-submit"),u=r?.value.trim()||"";if(u){c&&(c.disabled=!0);try{const l=await o.api("POST",`/features/${t}/comments`,{text:u});o.currentComments.push(l),s&&o.renderCommentsList(o.currentComments,s),e.commentsCount=o.currentComments.length;const d=o.container.querySelector(`.wfl-card[data-id="${t}"]`)?.querySelector(".wfl-comment-count");if(d){const f=e.commentsCount===1?o.t.comment||"comment":o.t.comments||"comments";d.textContent=`${e.commentsCount} ${f}`}r&&(r.value=""),o.showToast(o.t.commentAdded||"Comment added!","success")}catch(l){console.error("WPFeatureLoop: Failed to add comment",l),o.showToast(l.message||o.t.errorText||"Please try again later.","error")}finally{c&&(c.disabled=!1)}}},a=this.commentModal?.querySelector("#wfl-comment-submit"),i=this.commentModal?.querySelector("#wfl-comment-input");if(a){const r=a.cloneNode(!0);a.parentNode.replaceChild(r,a),r.addEventListener("click",n)}if(i){const r=i.cloneNode(!0);i.parentNode.replaceChild(r,i),r.addEventListener("keypress",c=>{c.key==="Enter"&&n()})}}closeCommentModal(){if(this.commentModal){this.commentModal.classList.remove("wfl-active");const t=this.commentModal.querySelector("#wfl-comment-input");t&&(t.value=""),this.currentCommentFeatureId=null,this.currentComments=[]}}async handleVote(t){const e=t.dataset.id,o=t.dataset.action,s=this.features.find(d=>String(d.id)===String(e));if(!s)return;const n=this.container.querySelector(`.wfl-card[data-id="${e}"]`),a=n?.querySelector(".wfl-vote-count"),i=n?.querySelector(".wfl-vote-up"),r=n?.querySelector(".wfl-vote-down");i&&(i.disabled=!0),r&&(r.disabled=!0);const c=s.votes,u=s.userVote;let l="none",m=0;o==="up"?s.userVote==="up"?(m=-1,l="none"):s.userVote==="down"?(m=2,l="up"):(m=1,l="up"):s.userVote==="down"?(m=1,l="none"):s.userVote==="up"?(m=-2,l="down"):(m=-1,l="down"),s.votes+=m,s.userVote=l==="none"?null:l,n&&this.updateVoteUI(n,s),a&&(a.classList.add("wfl-animating"),setTimeout(()=>a.classList.remove("wfl-animating"),300)),o==="up"&&l==="up"&&i&&this.createConfetti(i);try{const d=await this.api("POST",`/features/${e}/vote`,{vote:l});d.totalVotes!==void 0&&(s.votes=d.totalVotes),d.vote!==void 0&&(s.userVote=d.vote),n&&this.updateVoteUI(n,s)}catch(d){console.error("WPFeatureLoop: Failed to save vote",d),s.votes=c,s.userVote=u,n&&this.updateVoteUI(n,s),this.showToast(d.message||this.t.errorText||"Please try again later.","error")}finally{i&&(i.disabled=!1),r&&(r.disabled=!1)}}updateVoteUI(t,e){const o=t.querySelector(".wfl-vote-count"),s=t.querySelector(".wfl-vote-up"),n=t.querySelector(".wfl-vote-down");s&&s.classList.toggle("wfl-voted",e.userVote==="up"),n&&n.classList.toggle("wfl-voted",e.userVote==="down"),o&&(o.textContent=e.votes,o.classList.remove("wfl-vote-positive","wfl-vote-negative"),e.votes>0?o.classList.add("wfl-vote-positive"):e.votes<0&&o.classList.add("wfl-vote-negative"))}createConfetti(t){const e=["#3b82f6","#2563eb","#1d4ed8","#10b981","#f59e0b"],o=t.getBoundingClientRect();for(let s=0;s<6;s++){const n=document.createElement("div");n.className="wfl-confetti",n.style.left=`${o.left+o.width/2+(Math.random()-.5)*30}px`,n.style.top=`${o.top+o.height/2}px`,n.style.background=e[Math.floor(Math.random()*e.length)],n.style.position="fixed",document.body.appendChild(n),setTimeout(()=>n.remove(),600)}}showToast(t,e="default"){this.toast&&(this.toast.textContent=t,this.toast.className="wfl-toast wfl-active",e==="success"?this.toast.classList.add("wfl-toast-success"):e==="error"&&this.toast.classList.add("wfl-toast-error"),setTimeout(()=>{this.toast.classList.remove("wfl-active")},3e3))}async refresh(){this.container.setAttribute("data-loading","true"),await this.loadFeatures()}}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".wfl-container").forEach(function(h){try{var t=JSON.parse(h.dataset.config||"{}");new p(h,t).init()}catch(e){console.error("WPFeatureLoop: Failed to init widget",e)}})})})();
